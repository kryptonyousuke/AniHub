"use strict";const{app:c,globalShortcut:f,BrowserWindow:g,ipcMain:u,dialog:m}=require("electron"),l=require("path"),d=require("fs");require("os");const{spawn:p}=require("child_process");u.on("window-action",(e,t)=>{const n=g.getFocusedWindow();if(n)switch(t){case"minimize":n.minimize();break;case"maximize":n.isFullScreen()?(n.setFullScreen(!1),n.unmaximize()):n.isMaximized()?n.unmaximize():n.maximize();break;case"toggle-fullscreen":n.setFullScreen(!n.isFullScreen());break;case"close":n.close();break}});u.handle("window-is-maximized",()=>{const e=g.getFocusedWindow();return e?e.isMaximized():!1});u.handle("install-plugin",async()=>{const e=await m.showOpenDialog({properties:["openFile"],filters:[{extensions:["js","py"]}]});if(e.canceled||e.filePaths.length===0)return{success:!1,message:"No files selected."};const t=e.filePaths[0],n=l.basename(t),o=l.join(c.getPath("userData"),"plugins");d.existsSync(o)||d.mkdirSync(o,{recursive:!0});const i=l.join(o,n);try{return d.copyFileSync(t,i),{success:!0,path:i}}catch(r){return{success:!1,message:r.message}}});function h(e,t){return new Promise((n,o)=>{const i=p(e,{stdio:["pipe","pipe","pipe"]});let r="",a="";i.stdout.on("data",s=>{r+=s.toString()}),i.stderr.on("data",s=>{a+=s.toString()}),i.on("close",s=>{s===0?n(r.trim()):o(new Error(a||`Plugin falhou com código ${s}`))}),i.stdin.write(JSON.stringify(t)),i.stdin.end()})}function S(e,t){return new Promise((n,o)=>{const i=p(l.join(c.getPath("userData"),"plugins",e),{stdio:["pipe","pipe","pipe"]});let r="",a="";i.stdout.on("data",s=>{r+=s.toString()}),i.stderr.on("data",s=>{a+=s.toString()}),i.on("close",s=>{s===0?n(r.trim()):o(new Error(a||`Plugin falhou com código ${s}`))}),i.stdin.write(JSON.stringify(t)),i.stdin.end()})}u.handle("run-specific-plugin",async(e,t,n)=>await S(t,n));async function y(e){const t=l.join(c.getPath("userData"),"plugins");if(!d.existsSync(t))return[];const n=d.readdirSync(t),o=[];for(const i of n){const r=l.join(t,i);try{const a=await h(r,e);o.push({plugin:i,result:a})}catch(a){o.push({plugin:i,error:a.message})}}return o}u.handle("run-plugins",async(e,t)=>await y(t));function w(){const e=new g({width:1e3,height:700,minWidth:1e3,minHeight:300,frame:!1,titleBarStyle:"hidden",icon:l.join(__dirname,"build-icon/icons/png/1024x1024.png"),webPreferences:{contextIsolation:!0,nodeIntegration:!1,preload:l.join(__dirname,"preload.js")}});e.maximize(),e.on("maximize",()=>{e.webContents.send("window-state-changed","maximized")}),e.on("unmaximize",()=>{e.webContents.send("window-state-changed","restored")}),e.on("enter-full-screen",()=>{e.webContents.send("window-state-changed","fullscreen")}),e.on("leave-full-screen",()=>{e.webContents.send("window-state-changed","restored")}),c.isPackaged?(e.loadFile(l.join(__dirname,"./dist/renderer/index.html")),e.webContents.openDevTools()):(e.loadURL("http://localhost:5173"),e.webContents.openDevTools())}u.on("toggle-fullscreen",()=>{mainWindow&&mainWindow.setFullScreen(!mainWindow.isFullScreen())});c.whenReady().then(()=>{w(),c.on("activate",()=>{g.getAllWindows().length===0&&w()}),f.register("Ctrl+Shift+I",()=>{const e=g.getFocusedWindow();e&&e.webContents.toggleDevTools()})});c.on("window-all-closed",()=>{process.platform!=="darwin"&&c.quit()});
