"use strict";const{app:s,globalShortcut:m,BrowserWindow:p,ipcMain:u,dialog:f}=require("electron"),{spawn:w}=require("child_process"),a=require("path"),d=require("fs");require("os");s.commandLine.appendSwitch("js-flags","--max-old-space-size=4096 --optimize-for-size");s.commandLine.appendSwitch("disable-frame-rate-limit");s.commandLine.appendSwitch("enable-gpu-rasterization");s.commandLine.appendSwitch("enable-begin-frame-scheduling");s.commandLine.appendSwitch("enable-zero-copy");u.on("window-action",(e,t)=>{const n=p.getFocusedWindow();if(n)switch(t){case"minimize":n.minimize();break;case"maximize":n.isFullScreen()?(n.setFullScreen(!1),n.unmaximize()):n.isMaximized()?n.unmaximize():n.maximize();break;case"toggle-fullscreen":n.setFullScreen(!n.isFullScreen());break;case"close":n.close();break}});u.handle("window-is-maximized",()=>{const e=p.getFocusedWindow();return e?e.isMaximized():!1});u.handle("install-plugin",async()=>{const e=await f.showOpenDialog({properties:["openFile"],filters:[{extensions:["js","py"]}]});if(e.canceled||e.filePaths.length===0)return{success:!1,message:"No files selected."};const t=e.filePaths[0],n=a.basename(t),r=a.join(s.getPath("userData"),"plugins");d.existsSync(r)||d.mkdirSync(r,{recursive:!0});const i=a.join(r,n);try{return d.copyFileSync(t,i),{success:!0,path:i}}catch(l){return{success:!1,message:l.message}}});function h(e,t){return new Promise((n,r)=>{const i=w(e,{stdio:["pipe","pipe","pipe"]});let l="",c="";i.stdout.on("data",o=>{l+=o.toString()}),i.stderr.on("data",o=>{c+=o.toString()}),i.on("close",o=>{o===0?n(l.trim()):r(new Error(c||`Plugin falhou com cÃ³digo ${o}`))}),i.stdin.write(JSON.stringify(t)),i.stdin.end()})}function S(e,t){return new Promise((n,r)=>{const i=w(a.join(s.getPath("userData"),"plugins",e),{stdio:["pipe","pipe","pipe"]});let l="",c="";i.stdout.on("data",o=>{l+=o.toString()}),i.stderr.on("data",o=>{c+=o.toString()}),i.on("close",o=>{o===0?n(l.trim()):r(new Error(c||`Plugin failed with code: ${o}`))}),i.stdin.write(JSON.stringify(t)),i.stdin.end()})}u.handle("run-specific-plugin",async(e,t,n)=>await S(t,n));async function y(e){const t=a.join(s.getPath("userData"),"plugins");if(!d.existsSync(t))return[];const n=d.readdirSync(t),r=[];for(const i of n){const l=a.join(t,i);try{const c=await h(l,e);r.push({plugin:i,result:c})}catch(c){r.push({plugin:i,error:c.message})}}return r}u.handle("run-plugins",async(e,t)=>await y(t));async function b(){const e=a.join(s.getPath("userData"),"plugins");return d.existsSync(e)?d.readdirSync(e):[]}u.handle("get-all-plugins",async e=>await b());function g(){const e=new p({width:1e3,height:700,minWidth:1e3,minHeight:500,titleBarStyle:"hidden",icon:a.join(__dirname,"build-icon/icons/png/1024x1024.png"),webPreferences:{contextIsolation:!0,nodeIntegration:!1,offscreen:!1,preload:a.join(__dirname,"preload.js")},show:!0});e.maximize(),e.on("maximize",()=>{e.webContents.send("window-state-changed","maximized")}),e.on("unmaximize",()=>{e.webContents.send("window-state-changed","restored")}),e.on("enter-full-screen",()=>{e.webContents.send("window-state-changed","fullscreen")}),e.on("leave-full-screen",()=>{e.webContents.send("window-state-changed","restored")}),s.isPackaged?(e.loadFile(a.join(__dirname,"./dist/renderer/index.html")),e.webContents.openDevTools()):(e.loadURL("http://localhost:5173"),e.webContents.openDevTools())}u.on("toggle-fullscreen",()=>{mainWindow&&mainWindow.setFullScreen(!mainWindow.isFullScreen())});s.whenReady().then(()=>{g(),s.on("activate",()=>{p.getAllWindows().length===0&&g()}),m.register("Ctrl+Shift+I",()=>{const e=p.getFocusedWindow();e&&e.webContents.toggleDevTools()})});s.on("window-all-closed",()=>{process.platform!=="darwin"&&s.quit()});
